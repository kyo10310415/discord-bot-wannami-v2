const express = require('express');
const nacl = require('tweetnacl');
const app = express();
const PORT = process.env.PORT || 3000;

// DiscordÁΩ≤ÂêçÊ§úË®ºÈñ¢Êï∞
function verifyDiscordSignature(signature, timestamp, body, publicKey) {
  try {
    const timestampBuffer = Buffer.from(timestamp, 'utf8');
    const bodyBuffer = Buffer.from(body);
    const message = Buffer.concat([timestampBuffer, bodyBuffer]);
    
    const signatureBuffer = Buffer.from(signature, 'hex');
    const publicKeyBuffer = Buffer.from(publicKey, 'hex');
    
    return nacl.sign.detached.verify(message, signatureBuffer, publicKeyBuffer);
  } catch (error) {
    console.error('ÁΩ≤ÂêçÊ§úË®º„Ç®„É©„Éº:', error);
    return false;
  }
}

// Raw body parser for Discord webhook
app.use('/discord', express.raw({ type: 'application/json' }));
app.use(express.json());

// Health check
app.get('/', (req, res) => {
  res.json({ 
    status: 'ok', 
    message: 'Discord Bot Wannami V2 is running',
    timestamp: new Date().toISOString(),
    version: '2.0.0'
  });
});

// Discord webhook endpoint with signature verification
app.post('/discord', (req, res) => {
  console.log('=== Discord Request Received ===');
  console.log('Time:', new Date().toISOString());
  
  const signature = req.headers['x-signature-ed25519'];
  const timestamp = req.headers['x-signature-timestamp'];
  const publicKey = process.env.DISCORD_PUBLIC_KEY;
  
  console.log('Signature:', signature);
  console.log('Timestamp:', timestamp);
  console.log('Public Key:', publicKey ? 'Set' : 'Not Set');
  
  // Signature verification
  if (!publicKey) {
    console.error('DISCORD_PUBLIC_KEY environment variable not set');
    return res.status(500).json({ error: 'Public key not configured' });
  }
  
  const isValid = verifyDiscordSignature(signature, timestamp, req.body, publicKey);
  console.log('Signature verification result:', isValid);
  
  if (!isValid) {
    console.error('Signature verification failed');
    return res.status(401).json({ error: 'Invalid signature' });
  }
  
  let body;
  try {
    body = JSON.parse(req.body.toString());
    console.log('Request Type:', body.type);
  } catch (error) {
    console.error('JSON Parse Error:', error);
    return res.status(400).json({ error: 'Invalid JSON' });
  }
  
  // Handle Discord PING (Type 1)
  if (body.type === 1) {
    console.log('Discord PING - Responding with PONG');
    return res.json({ type: 1 });
  }
  
  // Handle Slash Commands (Type 2)
  if (body.type === 2) {
    console.log('Slash Command Received:', body.data?.name);
    
    const response = {
      type: 4, // CHANNEL_MESSAGE_WITH_SOURCE
      data: {
        content: `„Åì„Çì„Å´„Å°„ÅØ <@${body.member?.user?.id || body.user?.id}>„Åï„ÇìÔºÅ\n„Å©„ÅÆ„Çà„ÅÜ„Å™„ÅîÁõ∏Ë´á„Åß„Åó„Çá„ÅÜ„ÅãÔºü‰ª•‰∏ã„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºö`,
        components: [
          {
            type: 1, // ACTION_ROW
            components: [
              {
                type: 2, // BUTTON
                style: 1, // PRIMARY
                label: 'üí∞ „ÅäÊîØÊâï„ÅÑ„Å´Èñ¢„Åô„ÇãÁõ∏Ë´á',
                custom_id: 'payment_consultation'
              },
              {
                type: 2,
                style: 2, // SECONDARY
                label: 'üîí „Éó„É©„Ç§„Éô„Éº„Éà„Å™„ÅîÁõ∏Ë´á',
                custom_id: 'private_consultation'
              },
              {
                type: 2,
                style: 3, // SUCCESS
                label: 'üìö „É¨„ÉÉ„Çπ„É≥„Å´„Å§„ÅÑ„Å¶„ÅÆË≥™Âïè',
                custom_id: 'lesson_question'
              }
            ]
          },
          {
            type: 1,
            components: [
              {
                type: 2,
                style: 3,
                label: 'üì± X„ÉªYouTube„ÅÆÈÅãÁî®Áõ∏Ë´á',
                custom_id: 'sns_consultation'
              },
              {
                type: 2,
                style: 1,
                label: 'üìã „Éü„ÉÉ„Ç∑„Éß„É≥„ÅÆÊèêÂá∫',
                custom_id: 'mission_submission'
              }
            ]
          }
        ]
      }
    };
    
    console.log('Sending menu response');
    return res.json(response);
  }
  
  // Handle Button Clicks (Type 3)
  if (body.type === 3) {
    console.log('Button Click:', body.data?.custom_id);
    
    const customId = body.data.custom_id;
    let responseContent = '';
    
    switch (customId) {
      case 'payment_consultation':
        responseContent = "Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„ÅäÊîØÊâï„ÅÑ„Å´Èñ¢„Åó„Å¶„ÅØ„Åì„Åì„Åß„ÅØÁõ∏Ë´á„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\nüí° ÁÆ°ÁêÜËÄÖ„Å´„ÅîÁõ∏Ë´á„Åè„Å†„Åï„ÅÑ„ÄÇ";
        break;
      case 'private_consultation':
        responseContent = "Áî≥„ÅóË®≥„Åî„Åñ„ÅÑ„Åæ„Åõ„Çì„ÄÇ„Éó„É©„Ç§„Éô„Éº„Éà„Å™„ÅîÁõ∏Ë´á„Å´„Å§„ÅÑ„Å¶„ÅØ\n„Åì„Åì„Åß„ÅØÂõûÁ≠î„Åß„Åç„Åæ„Åõ„Çì„ÄÇ\n\nüéì **ÊãÖ‰ªª„ÅÆÂÖàÁîü„Å´Áõ¥Êé•„ÅîÁõ∏Ë´á„Åè„Å†„Åï„ÅÑ„ÄÇ**";
        break;
      case 'lesson_question':
        responseContent = "üìö **„É¨„ÉÉ„Çπ„É≥„Å´„Å§„ÅÑ„Å¶„ÅÆ„ÅîË≥™Âïè„Åß„Åô„Å≠ÔºÅ**\n\nü§ñ AIÂõûÁ≠îÊ©üËÉΩ„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ\n„ÇÇ„ÅÜ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ";
        break;
      case 'sns_consultation':
        responseContent = "üì± **X„ÉªYouTube„ÅÆÈÅãÁî®Áõ∏Ë´á„Åß„Åô„Å≠ÔºÅ**\n\nü§ñ AIÂõûÁ≠îÊ©üËÉΩ„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ\n„ÇÇ„ÅÜ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ";
        break;
      case 'mission_submission':
        responseContent = "üìã **„Éü„ÉÉ„Ç∑„Éß„É≥„ÅÆÊèêÂá∫„Åß„Åô„Å≠ÔºÅ**\n\nü§ñ AIÂõûÁ≠îÊ©üËÉΩ„ÅØÁèæÂú®Ê∫ñÂÇô‰∏≠„Åß„Åô„ÄÇ\n„ÇÇ„ÅÜ„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ„ÄÇ";
        break;
      default:
        responseContent = "‚ùå Ë™çË≠ò„Åß„Åç„Å™„ÅÑÈÅ∏ÊäûËÇ¢„Åß„Åô„ÄÇ\nÂÜçÂ∫¶„É°„Éã„É•„Éº„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
    }
    
    const response = {
      type: 4,
      data: {
        content: responseContent,
        flags: 64 // EPHEMERAL (Êú¨‰∫∫„ÅÆ„ÅøË°®Á§∫)
      }
    };
    
    console.log('Sending button response');
    return res.json(response);
  }
  
  // Default response
  res.json({ message: 'Request received' });
});

// Start server
app.listen(PORT, () => {
  console.log('=== Server Started ===');
  console.log(`Port: ${PORT}`);
  console.log(`Time: ${new Date().toISOString()}`);
  console.log(`Discord Public Key: ${process.env.DISCORD_PUBLIC_KEY ? 'Set' : 'Not Set'}`);
  console.log('====================');
});
